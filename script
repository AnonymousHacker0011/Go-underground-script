-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- PLAYER
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- SETTINGS
local swimSpeed = 25
local submergeOffset = 7.5
local riseMultiplier = 1

-- STATES
local submerged = false
local animationPlaying = false
local savedSubmergePosition
local originalCameraCFrame

-- CHARACTER REFERENCES (set on spawn)
local character
local humanoid
local rootPart
local animator
local animationTrack
local highlight
local noclipParts = {}

-- GUI positions
local playerData = {
	buttonPosition = UDim2.new(1, -175, 0.5, -100),
	animationButtonPosition = UDim2.new(1, -175, 0.5, -40)
}

-- =========================
-- GUI
-- =========================
local gui = Instance.new("ScreenGui")
gui.Name = "SubmergeGUI"
gui.ResetOnSpawn = false -- ðŸ”‘ IMPORTANT
gui.Parent = player:WaitForChild("PlayerGui")

local function makeButton(text, position, color)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0,150,0,50)
	btn.Position = position
	btn.AnchorPoint = Vector2.new(1,0.5)
	btn.BackgroundColor3 = color
	btn.BackgroundTransparency = 0.2
	btn.TextColor3 = Color3.new(1,1,1)
	btn.TextStrokeTransparency = 0
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 18
	btn.Text = text
	btn.BorderSizePixel = 0
	btn.Draggable = true
	btn.Parent = gui

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0,15)
	corner.Parent = btn

	return btn
end

local submergeButton = makeButton(
	"Submerge",
	playerData.buttonPosition,
	Color3.fromRGB(0,100,200)
)

local animationButton = makeButton(
	"Arm up: On/Off",
	playerData.animationButtonPosition,
	Color3.fromRGB(0,200,100)
)

-- =========================
-- CHARACTER SETUP
-- =========================
local function setupCharacter(char)
	character = char
	humanoid = character:WaitForChild("Humanoid")
	rootPart = character:WaitForChild("HumanoidRootPart")

	-- Animator
	animator = humanoid:WaitForChild("Animator")

	-- Animation
	local animation = Instance.new("Animation")
	animation.AnimationId = "rbxassetid://536135263"
	animationTrack = animator:LoadAnimation(animation)
	animationTrack.Looped = false

	-- Highlight
	if highlight then highlight:Destroy() end
	highlight = Instance.new("Highlight")
	highlight.Enabled = false
	highlight.FillTransparency = 1
	highlight.OutlineTransparency = 0
	highlight.OutlineColor = Color3.new(1,1,1)
	highlight.Parent = character

	-- Noclip parts
	table.clear(noclipParts)
	for _, part in ipairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			table.insert(noclipParts, part)
		end
	end

	-- Reset states
	submerged = false
	animationPlaying = false
	submergeButton.Text = "Submerge"
	animationButton.Text = "Arm up: On/Off"
end

player.CharacterAdded:Connect(setupCharacter)
if player.Character then
	setupCharacter(player.Character)
end

-- =========================
-- HELPERS
-- =========================
local function toggleNoclip(state)
	for _, part in ipairs(noclipParts) do
		part.CanCollide = not state
	end
end

-- =========================
-- SUBMERGE / SURFACE
-- =========================
local function submerge()
	originalCameraCFrame = camera.CFrame
	savedSubmergePosition = rootPart.Position - Vector3.new(0, submergeOffset, 0)

	toggleNoclip(true)
	humanoid.PlatformStand = true
	highlight.Enabled = true
	submerged = true

	rootPart.CFrame =
		CFrame.new(savedSubmergePosition)
		* CFrame.Angles(math.pi / 2, 0, 0)

	submergeButton.Text = "Rise Up"
end

local function surface()
	submerged = false

	toggleNoclip(false)
	humanoid.PlatformStand = false
	highlight.Enabled = false

	rootPart.CFrame =
		CFrame.new(rootPart.Position + Vector3.new(0, submergeOffset * riseMultiplier, 0))

	camera.CFrame = originalCameraCFrame
	submergeButton.Text = "Submerge"
end

-- =========================
-- ANIMATION TOGGLE
-- =========================
local function toggleAnimation()
	if not animationTrack then return end

	if animationPlaying then
		animationPlaying = false
		animationTrack:Stop()
		animationButton.Text = "Arm up: On/Off"
	else
		animationPlaying = true
		animationButton.Text = "Arm up: Off"

		task.spawn(function()
			while animationPlaying do
				animationTrack:Play()
				animationTrack.TimePosition = 0.2
				task.wait(0.03)
			end
		end)
	end
end

-- =========================
-- MAIN LOOP
-- =========================
RunService.RenderStepped:Connect(function()
	if submerged and rootPart and humanoid then
		toggleNoclip(true)

		rootPart.CFrame =
			CFrame.new(
				rootPart.Position.X,
				savedSubmergePosition.Y,
				rootPart.Position.Z
			) * CFrame.Angles(math.pi / 2, 0, 0)

		rootPart.Velocity = humanoid.MoveDirection * swimSpeed
	end
end)

-- =========================
-- BUTTON EVENTS
-- =========================
submergeButton.MouseButton1Click:Connect(function()
	if submerged then
		surface()
	else
		submerge()
	end
end)

animationButton.MouseButton1Click:Connect(toggleAnimation)

-- =========================
-- SAVE GUI POSITION
-- =========================
submergeButton:GetPropertyChangedSignal("Position"):Connect(function()
	playerData.buttonPosition = submergeButton.Position
end)

animationButton:GetPropertyChangedSignal("Position"):Connect(function()
	playerData.animationButtonPosition = animationButton.Position
end)
