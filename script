-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- PLAYER SETUP
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")
local camera = workspace.CurrentCamera

-- SETTINGS
local swimSpeed = 25
local submergeOffset = 8
local riseMultiplier = 1

-- STATES
local submerged = false
local savedSubmergePosition
local originalCameraCFrame
local animationPlaying = false

-- Noclip list
local noclipParts = {}

-- GUI positions
local playerData = {
	buttonPosition = UDim2.new(1, -175, 0.5, -100),
	animationButtonPosition = UDim2.new(1, -175, 0.5, -40)
}

-- =========================
-- ANIMATION
-- =========================
local animation = Instance.new("Animation")
animation.AnimationId = "rbxassetid://536135263"

local animator = humanoid:WaitForChild("Animator")
local animationTrack = animator:LoadAnimation(animation)
animationTrack.Looped = false

-- =========================
-- GUI
-- =========================
local gui = Instance.new("ScreenGui")
gui.Name = "SubmergeGUI"
gui.Parent = player:WaitForChild("PlayerGui")

local function makeButton(text, position, color)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0,150,0,50)
	btn.Position = position
	btn.AnchorPoint = Vector2.new(1,0.5)
	btn.BackgroundColor3 = color
	btn.BackgroundTransparency = 0.2
	btn.TextColor3 = Color3.new(1,1,1)
	btn.TextStrokeTransparency = 0
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 18
	btn.Text = text
	btn.BorderSizePixel = 0
	btn.Draggable = true
	btn.Parent = gui

	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0,15)
	corner.Parent = btn

	return btn
end

local submergeButton = makeButton(
	"Submerge",
	playerData.buttonPosition,
	Color3.fromRGB(0,100,200)
)

local animationButton = makeButton(
	"Arm up: On/Off",
	playerData.animationButtonPosition,
	Color3.fromRGB(0,200,100)
)

-- =========================
-- HIGHLIGHT
-- =========================
local highlight = Instance.new("Highlight")
highlight.Enabled = false
highlight.FillTransparency = 1
highlight.OutlineTransparency = 0
highlight.OutlineColor = Color3.new(1,1,1)
highlight.Parent = character

-- =========================
-- Noclip setup
-- =========================
for _, part in ipairs(character:GetDescendants()) do
	if part:IsA("BasePart") then
		table.insert(noclipParts, part)
	end
end

local function toggleNoclip(state)
	for _, part in ipairs(noclipParts) do
		part.CanCollide = not state
	end
end

-- =========================
-- SUBMERGE / SURFACE
-- =========================
local function submerge()
	originalCameraCFrame = camera.CFrame
	savedSubmergePosition = rootPart.Position - Vector3.new(0, submergeOffset, 0)

	toggleNoclip(true)
	humanoid.PlatformStand = true
	highlight.Enabled = true
	submerged = true

	-- Face UP
	rootPart.CFrame =
		CFrame.new(savedSubmergePosition)
		* CFrame.Angles(math.pi / 2, 0, 0)

	submergeButton.Text = "Rise Up"
end

local function surface()
	submerged = false

	toggleNoclip(false)
	humanoid.PlatformStand = false
	highlight.Enabled = false

	rootPart.CFrame =
		CFrame.new(rootPart.Position + Vector3.new(0, submergeOffset * riseMultiplier, 0))

	camera.CFrame = originalCameraCFrame
	submergeButton.Text = "Submerge"
end

-- =========================
-- ANIMATION TOGGLE
-- =========================
local function toggleAnimation()
	if animationPlaying then
		animationPlaying = false
		animationTrack:Stop()
		animationButton.Text = "Arm up: On/Off"
	else
		animationPlaying = true
		animationButton.Text = "Arm up: Off"

		task.spawn(function()
			while animationPlaying do
				animationTrack:Play()
				animationTrack.TimePosition = 0.2
				task.wait(0.03)
			end
		end)
	end
end

-- =========================
-- MAIN LOOP
-- =========================
RunService.RenderStepped:Connect(function()
	if submerged then
		toggleNoclip(true)

		rootPart.CFrame =
			CFrame.new(
				rootPart.Position.X,
				savedSubmergePosition.Y,
				rootPart.Position.Z
			) * CFrame.Angles(math.pi / 2, 0, 0)

		rootPart.Velocity = humanoid.MoveDirection * swimSpeed
	end
end)

-- =========================
-- BUTTON EVENTS
-- =========================
submergeButton.MouseButton1Click:Connect(function()
	if submerged then
		surface()
	else
		submerge()
	end
end)

animationButton.MouseButton1Click:Connect(toggleAnimation)

-- =========================
-- SAVE GUI POSITION
-- =========================
submergeButton:GetPropertyChangedSignal("Position"):Connect(function()
	playerData.buttonPosition = submergeButton.Position
end)

animationButton:GetPropertyChangedSignal("Position"):Connect(function()
	playerData.animationButtonPosition = animationButton.Position
end)

player.CharacterAdded:Connect(function()
	task.wait(0.05)
	submergeButton.Position = playerData.buttonPosition
	animationButton.Position = playerData.animationButtonPosition
end)
